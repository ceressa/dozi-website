<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.google.com https://www.gstatic.com; style-src 'self' 'unsafe-inline'; frame-src https://www.google.com; connect-src 'self' https://europe-west3-dozi-app.cloudfunctions.net;">
    
    <title>GDPR Data Request | Dozi</title>
    <meta name="description" content="Submit a GDPR data request for your personal information">
    <meta name="robots" content="noindex, nofollow">
    
    <link rel="icon" type="image/png" href="../dozi_brand.png">
    
    <!-- reCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=6Lcp60MsAAAAAFZ4qhzifUXH7YRmVfhFu2n36epX"></script>
    
    <style>
        :root {
            --dozi-turquoise: #40E0D0;
            --dozi-dark: #0f172a;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --bg-light: #f8fafc;
            --success: #10b981;
            --danger: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-light); color: var(--text-primary); line-height: 1.6; }
        
        .container { max-width: 700px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
        
        .header { text-align: center; margin-bottom: 2rem; }
        .header img { height: 48px; margin-bottom: 1rem; }
        .header h1 { font-size: 1.75rem; color: var(--dozi-dark); margin-bottom: 0.5rem; }
        .header p { color: var(--text-secondary); }
        
        .info-box { background: #e0f2fe; border-left: 4px solid #0284c7; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; }
        .info-box h3 { color: #075985; margin-bottom: 0.5rem; font-size: 1rem; }
        .info-box ul { margin: 0.5rem 0 0 1.5rem; color: #075985; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); }
        .form-group label .required { color: var(--danger); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--dozi-turquoise); }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group small { display: block; margin-top: 0.25rem; color: var(--text-secondary); font-size: 0.875rem; }
        
        .request-types { display: grid; gap: 0.75rem; margin-bottom: 1.5rem; }
        .request-type { padding: 1rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .request-type:hover { border-color: var(--dozi-turquoise); background: #f0fdfa; }
        .request-type input[type="radio"] { margin-right: 0.5rem; }
        .request-type label { cursor: pointer; font-weight: 600; }
        .request-type p { margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-secondary); }
        
        .btn { display: block; width: 100%; padding: 1rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: var(--dozi-turquoise); color: white; }
        .btn-primary:hover:not(:disabled) { background: #2dd4bf; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(64, 224, 208, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .success-message, .error-message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .success-message { background: #d1fae5; color: #065f46; border-left: 4px solid var(--success); }
        .error-message { background: #fee2e2; color: #991b1b; border-left: 4px solid var(--danger); }
        .success-message.show, .error-message.show { display: block; }
        
        .back-link { text-align: center; margin-top: 1.5rem; }
        .back-link a { color: var(--dozi-turquoise); text-decoration: none; font-weight: 500; }
        .back-link a:hover { text-decoration: underline; }
        
        .recaptcha-notice { font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-top: 1rem; }
        
        @media (max-width: 640px) {
            .container { margin: 1rem auto; }
            .card { padding: 1.5rem; }
            .header h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <img src="../dozi_brand.png" alt="Dozi">
                <h1>üìã GDPR Data Request</h1>
                <p>Exercise your data protection rights</p>
            </div>
            
            <div class="info-box">
                <h3>üìå Your GDPR Rights:</h3>
                <ul>
                    <li><strong>Right to Access:</strong> Know what data we process about you</li>
                    <li><strong>Right to Rectification:</strong> Correct inaccurate or incomplete data</li>
                    <li><strong>Right to Erasure:</strong> Request deletion of your data</li>
                    <li><strong>Right to Data Portability:</strong> Receive your data in a structured format</li>
                    <li><strong>Right to Object:</strong> Object to automated decision-making</li>
                    <li><strong>Right to Restriction:</strong> Limit how we use your data</li>
                </ul>
            </div>
            
            <div id="successMessage" class="success-message"></div>
            <div id="errorMessage" class="error-message"></div>
            
            <form id="gdprForm">
                <div class="form-group">
                    <label>Request Type <span class="required">*</span></label>
                    <div class="request-types">
                        <div class="request-type">
                            <input type="radio" id="access" name="requestType" value="access" required>
                            <label for="access">Data Access Request</label>
                            <p>Learn what data we process about you</p>
                        </div>
                        <div class="request-type">
                            <input type="radio" id="correction" name="requestType" value="correction">
                            <label for="correction">Data Correction Request</label>
                            <p>Request correction of inaccurate/incomplete data</p>
                        </div>
                        <div class="request-type">
                            <input type="radio" id="deletion" name="requestType" value="deletion">
                            <label for="deletion">Data Deletion Request</label>
                            <p>Request deletion/erasure of your data</p>
                        </div>
                        <div class="request-type">
                            <input type="radio" id="portability" name="requestType" value="portability">
                            <label for="portability">Data Portability Request</label>
                            <p>Receive your data in a structured format</p>
                        </div>
                        <div class="request-type">
                            <input type="radio" id="objection" name="requestType" value="objection">
                            <label for="objection">Objection Request</label>
                            <p>Object to automated processing</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" id="name" name="name" required maxlength="100">
                </div>
                
                <div class="form-group">
                    <label>Email Address <span class="required">*</span></label>
                    <input type="email" id="email" name="email" required maxlength="100">
                    <small>Response will be sent to this address</small>
                </div>
                
                <div class="form-group">
                    <label>Phone Number (Optional)</label>
                    <input type="tel" id="phone" name="phone" maxlength="20" placeholder="+1 XXX XXX XXXX">
                </div>
                
                <div class="form-group">
                    <label>User ID (Optional)</label>
                    <input type="text" id="userId" name="userId" maxlength="50">
                    <small>Settings > About > User ID</small>
                </div>
                
                <div class="form-group">
                    <label>Request Details <span class="required">*</span></label>
                    <textarea id="details" name="details" required maxlength="1000" placeholder="Please describe your request in detail..."></textarea>
                    <small>Provide clear and specific details about your request</small>
                </div>
                
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    Submit Request
                </button>
                
                <p class="recaptcha-notice">
                    This site is protected by reCAPTCHA. Google <a href="https://policies.google.com/privacy" target="_blank">Privacy Policy</a> and <a href="https://policies.google.com/terms" target="_blank">Terms of Service</a> apply.
                </p>
            </form>
            
            <div class="back-link">
                <a href="../privacy-policy.html">‚Üê Privacy Policy</a>
            </div>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('gdprForm');
        const submitBtn = document.getElementById('submitBtn');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        
        // reCAPTCHA site key
        const RECAPTCHA_SITE_KEY = '6Lcp60MsAAAAAFZ4qhzifUXH7YRmVfhFu2n36epX';
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Clear messages
            successMessage.classList.remove('show');
            errorMessage.classList.remove('show');
            
            // Disable button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                // Get reCAPTCHA token
                const recaptchaToken = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'data_request' });
                
                // Collect form data
                const requestType = document.querySelector('input[name="requestType"]:checked').value;
                const formData = {
                    requestType: requestType,
                    name: document.getElementById('name').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim() || null,
                    userId: document.getElementById('userId').value.trim() || null,
                    details: document.getElementById('details').value.trim(),
                    recaptchaToken: recaptchaToken
                };
                
                // Send to Firebase Function
                const response = await fetch('https://europe-west3-dozi-app.cloudfunctions.net/submitDataRequest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Success
                    successMessage.textContent = `‚úÖ ${data.message} Request ID: ${data.requestId}. Response time: ${data.responseDeadline}`;
                    successMessage.classList.add('show');
                    form.reset();
                } else {
                    // Error
                    errorMessage.textContent = `‚ùå ${data.error || 'An error occurred'}`;
                    errorMessage.classList.add('show');
                }
            } catch (error) {
                console.error('Form submission error:', error);
                errorMessage.textContent = '‚ùå Connection error. Please try again.';
                errorMessage.classList.add('show');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Request';
            }
        });
    </script>
</body>
</html>
