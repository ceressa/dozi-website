<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dozi - Ilac Takip</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5b6fd8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Dozi">
    <meta name="description" content="Ilac takibini akillica yonet - ilac hatirlatmalari, badi takibi ve istatistikler">
    
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dozi">
    <link rel="apple-touch-icon" href="../dozi_brand.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../dozi_brand.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <!-- Loading -->
    <div class="loading-screen" id="loadingScreen">
        <div class="dozi-loader">
            <img src="../images/dozi_hosgeldin_anim.gif" alt="Dozi" class="dozi-spin">
            <p>Dozi hazırlanıyor...</p>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display: none;">
        
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <img src="../images/dozi_brand.webp" alt="Dozi" class="header-logo">
                    <div class="header-info">
                        <h1 id="userName">Kullanıcı</h1>
                        <p id="todayDate">Bugün</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="notification-bell">
                        <button class="icon-btn" id="notificationBtn" title="Bildirimler">
                            <i class="ri-notification-3-line"></i>
                            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        </button>
                    </div>
                    <button class="icon-btn" id="refreshBtn" title="Yenile">
                        <i class="ri-refresh-line"></i>
                    </button>
                    <button class="icon-btn" id="logoutBtn" title="Çıkış">
                        <i class="ri-logout-box-r-line"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="today">
                <i class="ri-calendar-check-line"></i>
                <span>Bugün</span>
            </button>
            <button class="nav-tab" data-tab="medicines">
                <i class="ri-capsule-line"></i>
                <span>İlaçlarım</span>
            </button>
            <button class="nav-tab" data-tab="reminders">
                <i class="ri-alarm-line"></i>
                <span>Hatırlatmalar</span>
            </button>
            <button class="nav-tab" data-tab="stats">
                <i class="ri-bar-chart-line"></i>
                <span>İstatistikler</span>
            </button>
            <button class="nav-tab" data-tab="badis">
                <i class="ri-team-line"></i>
                <span>Badilerim</span>
            </button>
            <button class="nav-tab" data-tab="settings">
                <i class="ri-settings-3-line"></i>
                <span>Ayarlar</span>
            </button>
        </div>

        <!-- Tab Content: Today -->
        <div class="tab-content active" id="todayTab">
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-icon green">
                        <i class="ri-checkbox-circle-fill"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value" id="statTaken">0</span>
                        <span class="stat-label">Alındı</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon orange">
                        <i class="ri-time-fill"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value" id="statPending">0</span>
                        <span class="stat-label">Bekliyor</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon red">
                        <i class="ri-close-circle-fill"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value" id="statMissed">0</span>
                        <span class="stat-label">Kaçırıldı</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon purple">
                        <i class="ri-fire-fill"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value" id="statStreak">0</span>
                        <span class="stat-label">Seri</span>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="timeline-container">
                <div class="timeline-header">
                    <h2>İlaç Takvimi</h2>
                    <div class="timeline-filters">
                        <button class="filter-btn active" data-filter="all">Tümü</button>
                        <button class="filter-btn" data-filter="pending">Bekleyen</button>
                        <button class="filter-btn" data-filter="taken">Alınan</button>
                        <button class="filter-btn" data-filter="missed">Kaçırılan</button>
                    </div>
                </div>

                <div class="timeline" id="timeline">
                    <!-- Timeline items will be inserted here -->
                </div>

                <div class="empty-timeline" id="emptyTimeline" style="display: none;">
                    <img src="../images/dozi_happy5.webp" alt="Dozi" class="empty-dozi">
                    <h3>Bugün için ilaç yok!</h3>
                    <p>Harika! Bugün alman gereken ilaç bulunmuyor.</p>
                </div>
            </div>
        </div>

        <!-- Tab Content: Medicines -->
        <div class="tab-content" id="medicinesTab">
            <div class="medicines-header">
                <h2>İlaçlarım</h2>
                <button class="btn-primary" id="addMedicineBtn">
                    <i class="ri-add-line"></i>
                    İlaç Ekle
                </button>
            </div>
            <div class="medicines-grid" id="medicinesGrid">
                <!-- Medicine cards will be inserted here -->
            </div>
            <div class="empty-state" id="emptyMedicines" style="display: none;">
                <img src="../images/dozi_waiting.webp" alt="Dozi" class="empty-dozi">
                <h3>Henüz ilaç eklenmemiş</h3>
                <p>Yukarıdaki butona tıklayarak ilaç ekleyebilirsin.</p>
            </div>
        </div>

        <!-- Tab Content: Reminders -->
        <div class="tab-content" id="remindersTab">
            <div class="reminders-header">
                <h2>Hatırlatmalarım</h2>
                <p class="reminders-desc">Tüm ilaç hatırlatmalarını buradan görüntüle ve düzenle</p>
            </div>
            <div class="reminders-list" id="remindersList">
                <!-- Reminder cards will be inserted here -->
            </div>
            <div class="empty-state" id="emptyReminders" style="display: none;">
                <img src="../images/dozi_waiting.webp" alt="Dozi" class="empty-dozi">
                <h3>Henüz hatırlatma yok</h3>
                <p>İlaç ekleyerek hatırlatma oluşturabilirsin.</p>
            </div>
        </div>

        <!-- Tab Content: Stats -->
        <div class="tab-content" id="statsTab">
            <div class="stats-cards">
                <div class="stat-card-large">
                    <div class="stat-card-header">
                        <i class="ri-pie-chart-2-fill"></i>
                        <h3>Uyum Oranı</h3>
                    </div>
                    <div class="stat-card-value" id="adherencePercent">%0</div>
                    <div class="stat-card-desc">Son 7 günlük ortalama</div>
                </div>
                <div class="stat-card-large">
                    <div class="stat-card-header">
                        <i class="ri-fire-fill"></i>
                        <h3>Güncel Seri</h3>
                    </div>
                    <div class="stat-card-value" id="streakDays">0</div>
                    <div class="stat-card-desc">Gün üst üste</div>
                </div>
            </div>
            
            <!-- Weekly Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Haftalık Performans</h3>
                    <div class="chart-legend">
                        <span class="legend-item"><span class="legend-dot green"></span> Alındı</span>
                        <span class="legend-item"><span class="legend-dot red"></span> Kaçırıldı</span>
                    </div>
                </div>
                <canvas id="weeklyStatsChart"></canvas>
            </div>

            <!-- Daily Pattern Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Günlük Dağılım</h3>
                    <p class="chart-desc">Hangi saatlerde daha çok ilaç alıyorsun?</p>
                </div>
                <canvas id="dailyPatternChart"></canvas>
            </div>

            <!-- Medicine Adherence Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3>İlaç Bazlı Uyum</h3>
                    <p class="chart-desc">Her ilacın uyum oranı</p>
                </div>
                <canvas id="medicineAdherenceChart"></canvas>
            </div>
        </div>

        <!-- Tab Content: Badis -->
        <div class="tab-content" id="badisTab">
            <div class="badis-list" id="badisList">
                <!-- Badi cards will be inserted here -->
            </div>
            <div class="empty-state" id="emptyBadis" style="display: none;">
                <img src="../images/dozi_family.webp" alt="Dozi" class="empty-dozi">
                <h3>Henüz badi eklenmemiş</h3>
                <p>Mobil uygulamadan aile üyelerini ekleyebilirsin.</p>
            </div>
        </div>

        <!-- Tab Content: Settings -->
        <div class="tab-content" id="settingsTab">
            <div class="settings-container">
                <div class="settings-section">
                    <div class="settings-section-header">
                        <i class="ri-notification-3-line"></i>
                        <h3>Bildirim Ayarları</h3>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <h4>Web Bildirimleri</h4>
                            <p>Tarayıcı bildirimleri al</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="webNotificationsToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <h4>Bildirim Sesi</h4>
                            <p>Bildirim geldiğinde ses çal</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notificationSoundToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <h4>Hatırlatma Sıklığı</h4>
                            <p>Kaçırılan ilaçlar için tekrar hatırlat</p>
                        </div>
                        <select class="settings-select" id="reminderFrequency">
                            <option value="never">Hiçbir zaman</option>
                            <option value="15">15 dakika sonra</option>
                            <option value="30" selected>30 dakika sonra</option>
                            <option value="60">1 saat sonra</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-header">
                        <i class="ri-moon-line"></i>
                        <h3>Sessiz Saatler</h3>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <h4>Sessiz Saatleri Etkinleştir</h4>
                            <p>Belirli saatlerde bildirim alma</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="quietHoursToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item" id="quietHoursSettings" style="display: none;">
                        <div class="time-range-picker">
                            <div class="time-input-group">
                                <label>Başlangıç</label>
                                <input type="time" id="quietHoursStart" value="22:00">
                            </div>
                            <span class="time-separator">-</span>
                            <div class="time-input-group">
                                <label>Bitiş</label>
                                <input type="time" id="quietHoursEnd" value="08:00">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-header">
                        <i class="ri-palette-line"></i>
                        <h3>Görünüm</h3>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <h4>Tema</h4>
                            <p>Aydınlık veya karanlık mod</p>
                        </div>
                        <select class="settings-select" id="themeSelect">
                            <option value="light" selected>Aydınlık</option>
                            <option value="dark">Karanlık</option>
                            <option value="auto">Otomatik</option>
                        </select>
                    </div>
                </div>

                <div class="settings-actions">
                    <button class="btn-secondary" id="resetSettingsBtn">
                        <i class="ri-restart-line"></i>
                        Ayarları Sıfırla
                    </button>
                    <button class="btn-primary" id="saveSettingsBtn">
                        <i class="ri-save-line"></i>
                        Kaydet
                    </button>
                </div>
            </div>
        </div>

        <!-- Dozi Character (Floating) -->
        <div class="dozi-character" id="doziCharacter">
            <img src="../images/dozi_happy.webp" alt="Dozi">
            <div class="dozi-speech" id="doziSpeech" style="display: none;">
                <p id="doziMessage">Merhaba!</p>
            </div>
        </div>

    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Notification Panel -->
    <div class="notification-overlay" id="notificationOverlay"></div>
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-panel-header">
            <h2>
                <i class="ri-notification-3-fill"></i>
                Bildirimler
            </h2>
            <button class="notification-panel-close" id="notificationPanelClose">
                <i class="ri-close-line"></i>
            </button>
        </div>
        <div class="notification-panel-content" id="notificationPanelContent">
            <div class="notification-empty">
                <img src="../images/dozi_waiting.webp" alt="Dozi">
                <h3>Henüz bildirim yok</h3>
                <p>Yeni bildirimler burada görünecek</p>
            </div>
        </div>
    </div>

    <!-- Medicine Modal -->
    <div class="modal-overlay" id="medicineModalOverlay"></div>
    <div class="modal" id="medicineModal">
        <div class="modal-header">
            <h2 id="medicineModalTitle">İlaç Ekle</h2>
            <button class="modal-close" id="medicineModalClose">
                <i class="ri-close-line"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="medicineForm">
                <div class="form-group">
                    <label for="medicineName">İlaç Adı *</label>
                    <input type="text" id="medicineName" class="form-input" placeholder="Örn: Aspirin" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="medicineDosage">Doz *</label>
                        <input type="text" id="medicineDosage" class="form-input" placeholder="Örn: 100mg" required>
                    </div>
                    <div class="form-group">
                        <label for="medicineForm">Form</label>
                        <select id="medicineForm" class="form-select">
                            <option value="TABLET">Tablet</option>
                            <option value="CAPSULE">Kapsül</option>
                            <option value="SYRUP">Şurup</option>
                            <option value="INJECTION">Enjeksiyon</option>
                            <option value="CREAM">Krem</option>
                            <option value="DROP">Damla</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="medicineFrequency">Kullanım Sıklığı *</label>
                    <select id="medicineFrequency" class="form-select" required>
                        <option value="DAILY">Her gün</option>
                        <option value="WEEKLY">Haftada belirli günler</option>
                        <option value="INTERVAL">Belirli aralıklarla</option>
                        <option value="AS_NEEDED">Gerektiğinde</option>
                    </select>
                </div>

                <div class="form-group" id="reminderTimesGroup">
                    <label>Hatırlatıcı Saatleri *</label>
                    <div id="reminderTimesList">
                        <div class="reminder-time-item">
                            <input type="time" class="form-input reminder-time-input" value="09:00" required>
                            <button type="button" class="btn-icon-small remove-time-btn" style="display: none;">
                                <i class="ri-close-line"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn-secondary btn-small" id="addReminderTimeBtn">
                        <i class="ri-add-line"></i>
                        Saat Ekle
                    </button>
                </div>

                <div class="form-group">
                    <label for="medicineStock">Stok (Opsiyonel)</label>
                    <input type="number" id="medicineStock" class="form-input" placeholder="Kalan ilaç sayısı" min="0">
                </div>

                <div class="form-group">
                    <label for="medicineNotes">Notlar (Opsiyonel)</label>
                    <textarea id="medicineNotes" class="form-textarea" placeholder="İlaç hakkında notlar..." rows="3"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelMedicineBtn">İptal</button>
                    <button type="submit" class="btn-primary" id="saveMedicineBtn">
                        <i class="ri-save-line"></i>
                        Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- PWA Install Banner -->
    <div class="pwa-install-banner" id="pwaInstallBanner">
        <div class="pwa-install-content">
            <img src="../dozi_brand.png" alt="Dozi" class="pwa-install-icon">
            <div class="pwa-install-text">
                <h3>Dozi'yi Yukle</h3>
                <p>Ana ekranina ekle, uygulama gibi kullan</p>
            </div>
        </div>
        <div class="pwa-install-actions">
            <button class="pwa-install-btn" id="pwaInstallBtn">
                <i class="ri-download-2-line"></i> Yukle
            </button>
            <button class="pwa-install-dismiss" id="pwaInstallDismiss">
                <i class="ri-close-line"></i>
            </button>
        </div>
    </div>

    <!-- iOS Install Hint (shown inside settings tab) -->
    <div class="ios-pwa-hint" id="iosPwaHint" style="display: none;">
        <div class="ios-pwa-hint-content">
            <i class="ri-smartphone-line"></i>
            <p>
                Dozi'yi ana ekranina eklemek icin tarayicinin 
                <strong>Paylas</strong> butonuna tikla ve 
                <strong>"Ana Ekrana Ekle"</strong> sec.
            </p>
        </div>
    </div>

    <script src="dashboard.js"></script>

    <!-- PWA & FCM Integration -->
    <script>
        // ================================
        // PWA: Service Worker Registration
        // ================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/dozi/sw.js', {
                        scope: '/dozi/'
                    });
                    console.log('[PWA] Service Worker registered:', registration.scope);
                } catch (error) {
                    console.error('[PWA] Service Worker registration failed:', error);
                }
            });
        }

        // ================================
        // FCM: Web Push Notifications
        // ================================
        async function initFCM() {
            try {
                if (!('Notification' in window)) {
                    console.log('[FCM] Notifications not supported');
                    return;
                }

                if (!firebase.messaging) {
                    console.log('[FCM] Firebase Messaging not loaded');
                    return;
                }

                const messaging = firebase.messaging();
                
                // Get FCM token when permission is granted
                if (Notification.permission === 'granted') {
                    await registerFCMToken(messaging);
                }
            } catch (error) {
                console.error('[FCM] Init error:', error);
            }
        }

        async function registerFCMToken(messaging) {
            try {
                const currentToken = await messaging.getToken({
                    serviceWorkerRegistration: await navigator.serviceWorker.getRegistration('/dozi/')
                });
                
                if (currentToken && currentUser) {
                    console.log('[FCM] Token obtained:', currentToken.substring(0, 20) + '...');
                    
                    // Save FCM token to Firestore
                    await db.collection('users').doc(currentUser.uid).set({
                        webFcmToken: currentToken,
                        webFcmTokenUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        webPushEnabled: true
                    }, { merge: true });
                    
                    console.log('[FCM] Token saved to Firestore');
                }
            } catch (error) {
                console.error('[FCM] Token registration error:', error);
            }
        }

        // Handle foreground FCM messages
        async function setupForegroundMessages() {
            try {
                if (!firebase.messaging) return;
                
                const messaging = firebase.messaging();
                
                messaging.onMessage((payload) => {
                    console.log('[FCM] Foreground message:', payload);
                    
                    const title = payload.notification?.title || 'Dozi';
                    const body = payload.notification?.body || 'Ilac hatirlatmasi';
                    
                    // Show as toast notification in the dashboard
                    if (typeof showToast === 'function') {
                        showToast(title + ': ' + body, 'success');
                    }
                    
                    // Also show browser notification
                    if (Notification.permission === 'granted') {
                        new Notification(title, {
                            body: body,
                            icon: '/dozi_brand.png',
                            badge: '/dozi_brand.png',
                            tag: payload.data?.medicineId || 'dozi-fcm',
                            requireInteraction: true
                        });
                    }
                    
                    // Show Dozi message
                    if (typeof showDoziMessage === 'function') {
                        showDoziMessage(body, 'time');
                    }
                    
                    // Reload dashboard to reflect changes
                    if (typeof loadDashboard === 'function') {
                        setTimeout(() => loadDashboard(), 2000);
                    }
                });
            } catch (error) {
                console.error('[FCM] Foreground message setup error:', error);
            }
        }

        // Enhanced notification permission request with FCM token registration
        const originalRequestNotificationPermission = typeof requestNotificationPermission === 'function' ? requestNotificationPermission : null;
        
        window.requestNotificationPermissionWithFCM = async function() {
            if (!('Notification' in window)) {
                if (typeof showToast === 'function') {
                    showToast('Bu tarayici bildirimleri desteklemiyor', 'error');
                }
                return false;
            }
            
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    console.log('[FCM] Permission granted, registering token...');
                    
                    if (firebase.messaging) {
                        const messaging = firebase.messaging();
                        await registerFCMToken(messaging);
                    }
                    
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('[FCM] Permission request error:', error);
                return false;
            }
        };

        // Initialize FCM after auth
        const originalOnAuthStateChanged = auth.onAuthStateChanged;
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Wait a bit for dashboard to load, then init FCM
                setTimeout(async () => {
                    await initFCM();
                    await setupForegroundMessages();
                }, 3000);
            }
        });

        // ================================
        // PWA: Install Prompt
        // ================================
        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Check if user dismissed before
            const dismissed = localStorage.getItem('pwa-install-dismissed');
            const dismissedTime = dismissed ? parseInt(dismissed) : 0;
            const sevenDays = 7 * 24 * 60 * 60 * 1000;
            
            if (Date.now() - dismissedTime > sevenDays) {
                document.getElementById('pwaInstallBanner').style.display = 'flex';
            }
        });

        document.getElementById('pwaInstallBtn')?.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log('[PWA] Install outcome:', outcome);
            
            deferredPrompt = null;
            document.getElementById('pwaInstallBanner').style.display = 'none';
        });

        document.getElementById('pwaInstallDismiss')?.addEventListener('click', () => {
            document.getElementById('pwaInstallBanner').style.display = 'none';
            localStorage.setItem('pwa-install-dismissed', Date.now().toString());
        });

        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App installed');
            document.getElementById('pwaInstallBanner').style.display = 'none';
        });

        // ================================
        // iOS PWA Detection
        // ================================
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        function isInStandaloneMode() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }

        if (isIOS() && !isInStandaloneMode()) {
            const hint = document.getElementById('iosPwaHint');
            if (hint) hint.style.display = 'block';
        }

        // ================================
        // Handle notification action from SW
        // ================================
        const urlParams = new URLSearchParams(window.location.search);
        const actionFromSW = urlParams.get('action');
        const medicineIdFromSW = urlParams.get('medicineId');
        
        if (actionFromSW && medicineIdFromSW) {
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Wait for dashboard to load, then handle action
            window.addEventListener('load', () => {
                setTimeout(() => {
                    if (actionFromSW === 'take' && typeof markMedication === 'function') {
                        console.log('[PWA] Auto-marking medication from notification:', medicineIdFromSW);
                        // Find the medicine's scheduled time for today
                        const item = dashboardData?.timelineItems?.find(i => i.medicineId === medicineIdFromSW && i.status === 'pending');
                        if (item) {
                            markMedication(medicineIdFromSW, item.time, 'taken');
                        }
                    }
                }, 3000);
            });
        }
    </script>
</body>
</html>
